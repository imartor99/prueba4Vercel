name: CI/CD - Despliegue de Lista de Libros

on:
  push:
    branches:
      - develop # El workflow se activa con cada push a la rama develop
      - main

jobs:
  test:
    name: И Pruebas Unitarias (CI)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies (npm ci)
        # Instala dependencias (Jest y JSDoc)
        run: npm ci 

      - name: Run unit tests
        # Ejecuta el script 'test' que configuramos para Jest
        run: npm test

  docs:
    name:  Generar Documentaci贸n (JSDoc)
    runs-on: ubuntu-latest
    needs: test # Solo se ejecuta si las pruebas unitarias pasan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies (npm ci)
        # Necesitamos instalar dependencias de nuevo en este runner
        run: npm ci 

      - name: Generate JSDoc documentation
        # Llama al script 'docs' en package.json (asumiendo que es: "docs": "jsdoc -c jsdoc.json" o similar)
        run: npm run docs
        
      
      - name: Upload Documentation Artifact
        uses: actions/upload-artifact@v4
        with:
          name: jsdoc-documentation
          path: docs/ # Asume que jsdoc genera archivos en una carpeta llamada 'docs'

  deploy:
    name:  Despliegue de la Aplicaci贸n Principal en Vercel
    runs-on: ubuntu-latest
    needs: [docs] # Dependencia: El build de documentaci贸n debe ser exitoso
    
    steps:
      # Volvemos a hacer Checkout para asegurar que tenemos la carpeta 'docs' generada 
      # en el Job anterior y el resto de los archivos del proyecto.
      - name: Checkout del repositorio (Para despliegue final)
        uses: actions/checkout@v4
        
      - name: Download Documentation Artifact
        uses: actions/download-artifact@v4
        with:
          name: jsdoc-documentation
          path: docs/ # Asume que jsdoc genera archivos en una carpeta llamada 'docs'
        
      - name: Despliegue de la APLICACIN COMPLETA en Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }} 
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          # CRTICO: Apuntamos al directorio ra铆z (./) para que la app principal (index.html)
          # sea la que se muestre al usuario. La documentaci贸n estar谩 en /docs/index.html.
          working-directory: ./